var BinarySocket=function(){"use strict";!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.ByteBuffer=e()}}(function(){return function e(t,n,r){function i(a,u){if(!n[a]){if(!t[a]){var s="function"==typeof require&&require;if(!u&&s)return s(a,!0);if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var f=n[a]={exports:{}};t[a][0].call(f.exports,function(e){var n=t[a][1][e];return i(n?n:e)},f,f.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(e,t,n){function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){var t=void 0===arguments[0]?0:arguments[0],n=void 0===arguments[1]?this.constructor.BIG_ENDIAN:arguments[1],i=void 0===arguments[2]?!1:arguments[2];r(this,e),this._buffer=null,this._raw=null,this._view=null,this._order=!!n,this._implicitGrowth=!!i,this._index=0;var o=this._extractBuffer(t,!0);o||(o=new ArrayBuffer(t)),this.buffer=o}return i(e,[{key:"_sanitizeIndex",value:function(){this._index<0&&(this._index=0),this._index>this.length&&(this._index=this.length)}},{key:"_extractBuffer",value:function(e){var t=void 0===arguments[1]?!1:arguments[1];if(e&&"undefined"!=typeof e.byteLength)return"undefined"!=typeof e.buffer?t?e.buffer.slice(0):e.buffer:t?e.slice(0):e;if(!e||"undefined"==typeof e.length)return null;if(e.constructor==String)return null;try{return new Uint8Array(e).buffer}catch(n){return null}}},{key:"front",value:function(){return this._index=0,this}},{key:"end",value:function(){return this._index=this.length,this}},{key:"seek",value:function(){var e=void 0===arguments[0]?1:arguments[0];return this.index+=e,this}},{key:"read",value:function(){var t=void 0===arguments[0]?this.available:arguments[0];if(t>this.available)throw new Error("Cannot read "+t+" byte(s), "+this.available+" available");if(0>=t)throw new RangeError("Invalid number of bytes "+t);var n=new e(this._buffer.slice(this._index,this._index+t),this.order);return this._index+=t,n}},{key:"write",value:function(e){var t;if(e instanceof Uint8Array)t=e;else{var n=this._extractBuffer(e);if(!n)throw new TypeError("Cannot write "+e+", not a sequence");t=new Uint8Array(n)}var r=this.available;if(t.byteLength>r){if(!this._implicitGrowth)throw new Error("Cannot write "+e+" using "+t.byteLength+" byte(s), "+this.available+" available");this.append(t.byteLength-r)}return this._raw.set(t,this._index),this._index+=t.byteLength,this}},{key:"readString",value:function(){var e=void 0===arguments[0]?this.available:arguments[0];if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(0>=e)throw new RangeError("Invalid number of bytes "+e);for(var t,n,r,i=this._raw,o=[],a=0,u=null,s=this._index+e;this._index<s;)if(t=i[this._index],128>t)o[a++]=t,this._index++;else{if(194>t)throw new Error("Unexpected continuation byte");if(224>t){if(n=i[this._index+1],128>n||n>191)throw new Error("Bad continuation byte");o[a++]=((31&t)<<6)+(63&n),this._index+=2}else if(240>t){if(n=i[this._index+1],128>n||n>191)throw new Error("Bad continuation byte");if(r=i[this._index+2],128>r||r>191)throw new Error("Bad continuation byte");o[a++]=((15&t)<<12)+((63&n)<<6)+(63&r),this._index+=3}else{if(!(245>t))throw new Error("Illegal byte");if(n=i[this._index+1],128>n||n>191)throw new Error("Bad continuation byte");if(r=i[this._index+2],128>r||r>191)throw new Error("Bad continuation byte");if(u=i[this._index+3],128>u||u>191)throw new Error("Bad continuation byte");var f=((7&t)<<18)+((63&n)<<12)+((63&r)<<6)+(63&u);f-=65536,o[a++]=55296+((1047552&f)>>>10),o[a++]=56320+(1023&f),this._index+=4}}var c=65536,h=o.length;if(c>h)return String.fromCharCode.apply(String,o);for(var l=[],d=0;h>d;)l.push(String.fromCharCode.apply(String,o.slice(d,d+c))),d+=c;return l.join("")}},{key:"writeString",value:function(e){for(var t=[],n=e.length,r=0,i=0;n>r;){var o=e.charCodeAt(r);if(127>=o)t[i++]=o;else if(2047>=o)t[i++]=192|(1984&o)>>>6,t[i++]=128|63&o;else if(55295>=o||o>=57344&&65535>=o)t[i++]=224|(61440&o)>>>12,t[i++]=128|(4032&o)>>>6,t[i++]=128|63&o;else{if(r==n-1)throw new Error("Unpaired surrogate "+e[r]+" (index "+r+")");var a=e.charCodeAt(++r);if(55296>o||o>56319||56320>a||a>57343)throw new Error("Unpaired surrogate "+e[r]+" (index "+r+")");var u=((1023&o)<<10)+(1023&a)+65536;t[i++]=240|(1835008&u)>>>18,t[i++]=128|(258048&u)>>>12,t[i++]=128|(4032&u)>>>6,t[i++]=128|63&u}++r}return this.write(t),t.length}},{key:"readCString",value:function(){for(var e=this._raw,t=e.length,n=this._index;0!=e[n]&&t>n;)++n;if(t=n-this._index,t>0){var r=this.readString(t);return this.readByte(),r}return null}},{key:"writeCString",value:function(e){var t=this.writeString(e);return this.writeByte(0),++t}},{key:"prepend",value:function(e){if(0>=e)throw new RangeError("Invalid number of bytes "+e);var t=new Uint8Array(this.length+e);return t.set(this._raw,e),this._index+=e,this.buffer=t.buffer,this}},{key:"append",value:function(e){if(0>=e)throw new RangeError("Invalid number of bytes "+e);var t=new Uint8Array(this.length+e);return t.set(this._raw,0),this.buffer=t.buffer,this}},{key:"clip",value:function(){var e=void 0===arguments[0]?this._index:arguments[0],t=void 0===arguments[1]?this.length:arguments[1];0>e&&(e=this.length+e);var n=this._buffer.slice(e,t);return this._index-=e,this.buffer=n,this}},{key:"slice",value:function t(){var n=void 0===arguments[0]?0:arguments[0],r=void 0===arguments[1]?this.length:arguments[1],t=new e(this._buffer.slice(n,r),this.order);return t}},{key:"clone",value:function n(){var n=new e(this._buffer.slice(0),this.order,this.implicitGrowth);return n.index=this._index,n}},{key:"reverse",value:function(){return Array.prototype.reverse.call(this._raw),this._index=0,this}},{key:"toArray",value:function(){return Array.prototype.slice.call(this._raw,0)}},{key:"toString",value:function(){var e=this._order==this.constructor.BIG_ENDIAN?"big-endian":"little-endian";return"[ByteBuffer; Order: "+e+"; Length: "+this.length+"; Index: "+this._index+"; Available: "+this.available+"]"}},{key:"toHex",value:function(){var e=void 0===arguments[0]?" ":arguments[0];return Array.prototype.map.call(this._raw,function(e){return("00"+e.toString(16).toUpperCase()).slice(-2)}).join(e)}},{key:"toASCII",value:function(){var e=void 0===arguments[0]?" ":arguments[0],t=void 0===arguments[1]?!0:arguments[1],n=void 0===arguments[2]?"ï¿½":arguments[2],r=t?" ":"";return Array.prototype.map.call(this._raw,function(e){return 32>e||e>126?r+n:r+String.fromCharCode(e)}).join(e)}},{key:"buffer",get:function(){return this._buffer},set:function(e){this._buffer=e,this._raw=new Uint8Array(this._buffer),this._view=new DataView(this._buffer),this._sanitizeIndex()}},{key:"raw",get:function(){return this._raw}},{key:"view",get:function(){return this._view}},{key:"length",get:function(){return this._buffer.byteLength}},{key:"byteLength",get:function(){return this.length}},{key:"order",get:function(){return this._order},set:function(e){this._order=!!e}},{key:"implicitGrowth",get:function(){return this._implicitGrowth},set:function(e){this._implicitGrowth=!!e}},{key:"index",get:function(){return this._index},set:function(e){if(0>e||e>this.length)throw new RangeError("Invalid index "+e+", should be between 0 and "+this.length);this._index=e}},{key:"available",get:function(){return this.length-this._index}}],[{key:"LITTLE_ENDIAN",value:!0,enumerable:!0},{key:"BIG_ENDIAN",value:!1,enumerable:!0}]),e}(),a=function(e,t){return function(){var n=void 0===arguments[0]?this._order:arguments[0];if(t>this.available)throw new Error("Cannot read "+t+" byte(s), "+this.available+" available");var r=this._view[e](this._index,n);return this._index+=t,r}},u=function(e,t){return function(n){var r=void 0===arguments[1]?this._order:arguments[1],i=this.available;if(t>i){if(!this._implicitGrowth)throw new Error("Cannot write "+n+" using "+t+" byte(s), "+i+" available");this.append(t-i)}return this._view[e](this._index,n,r),this._index+=t,this}};o.prototype.readByte=a("getInt8",1),o.prototype.readUnsignedByte=a("getUint8",1),o.prototype.readShort=a("getInt16",2),o.prototype.readUnsignedShort=a("getUint16",2),o.prototype.readInt=a("getInt32",4),o.prototype.readUnsignedInt=a("getUint32",4),o.prototype.readFloat=a("getFloat32",4),o.prototype.readDouble=a("getFloat64",8),o.prototype.writeByte=u("setInt8",1),o.prototype.writeUnsignedByte=u("setUint8",1),o.prototype.writeShort=u("setInt16",2),o.prototype.writeUnsignedShort=u("setUint16",2),o.prototype.writeInt=u("setInt32",4),o.prototype.writeUnsignedInt=u("setUint32",4),o.prototype.writeFloat=u("setFloat32",4),o.prototype.writeDouble=u("setFloat64",8),t.exports=o},{}]},{},[1])(1)});var e={extend:function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]},throttle:function(e,t,n){var r=!1;return function(){var i=this,o=arguments;r||(n&&e.apply(i,o),r=!0,setTimeout(function(){r=!1,n||e.apply(i,o)},t))}}},t=function(t,n){function r(){if(!u.openTriggered&&(u.openTriggered=!0,d.onOpen))try{d.onOpen()}catch(e){console.log("BinarySocket: onOpen: catched exception:",e),u.close()}}function i(){if(!l&&(l=!0,d.onClose))try{d.onClose()}catch(e){console.log("BinarySocket: onClose: catched exception:",e)}}function o(e){if(!u.errorTriggered&&(u.errorTriggered=!0,d.onError))try{d.onError(e)}catch(t){console.log("BinarySocket: onError: catched exception:",t)}}function a(){!n.forceSocketType&&window.WebSocket||n.forceSocketType===c.WebSocket?(u=s(),u.socketType=c.WebSocket):(u=f(),u.socketType=c.AjaxSocket);var e=setTimeout(function(){e=!1,u.close(),o("connection timeout"),i()},n.connectTimeout),t=function(){e!==!1&&(clearTimeout(e),e=!1)};u.onOpen=function(){t(),r()},u.onClose=function(){t(),u.close(),i()},u.onError=function(e){t(),u.close(),o(e),i()},u.onMessage=function(e){try{d.onRead(e)}catch(t){console.log("BinarySocket: onRead: catched exception:",t)}},setTimeout(function(){u.open()},0)}var u,s=function(){var e,n={};return n.open=function(){try{var r;r=t.match("^https://")?"wss"+t.substr(5):"ws"+t.substr(4),e=new WebSocket(r),e.binaryType="arraybuffer",e.onmessage=function(e){n.onMessage(e.data)},e.onerror=function(e){var t="the websocket closed the connection with ";t+=e.code?"the error code: "+e.code:"an error.",n.onError(t)},e.onclose=function(){n.onClose()},e.onopen=function(){n.onOpen()}}catch(i){n.onError()}},n.send=function(t){e.send(t)},n.close=function(){if(e)try{e.close()}catch(t){}e=void 0},n},f=function(){function n(e,t,n,r,i){var o=new XMLHttpRequest;return o.onload=function(){r(o.response)},o.onerror=function(){i()},o.ontimeout=function(){i("timeout")},o.open("POST",e,!0),o.responseType="arraybuffer",o.timeout=t,o.send(new DataView(n)),o}function r(){c=function(){},p&&p.abort(),g&&g.abort()}function i(){r(),w.onClose()}function o(e){r(),e||(e="the ajax socket closed the connection with an error."),w.onError(e)}function a(e,r,i,a){var u=new ByteBuffer(3,ByteBuffer.BIG_ENDIAN,!0);u.writeByte(e);var s=0;r&&r.length>0&&(s=r.length),u.writeByte(s),s>0&&u.writeString(r),i&&i.byteLength>0&&u.write(i),g=n(t,h,u.buffer,function(e){g=!1,a&&a(e)},function(e){g=!1,o(e)})}var u,s,f,c,h=3e4,l=45e3,d="#",y={Init:0,Push:1,Poll:2},v={Data:0,Timeout:1,Closed:2},w={},p=!1,g=!1,b=!1,_=[];c=function(){var e=new ByteBuffer(3,ByteBuffer.BIG_ENDIAN,!0);e.writeByte(y.Poll);var r=u+d+s;e.writeByte(r.length),e.writeString(r),p=n(t,l,e.buffer,function(e){p=!1;var t=new ByteBuffer(e,ByteBuffer.BIG_ENDIAN);if(t.length<1)return void o("ajax socket: poll: invalid server response");var n=t.readByte();if(n==v.Closed)return void i();if(t.length<2)return void o("ajax socket: poll: invalid server response");var r=t.readByte();return s=t.readString(r),n==v.Timeout?void c():(c(),t.clip(),void w.onMessage(t.buffer))},function(e){p=!1,o(e)})};var B=e.throttle(function(){if(!b){var e,t=0;for(e=0;e<_.length;e++)t+=_[e].byteLength;var n=new ByteBuffer(t,ByteBuffer.BIG_ENDIAN);for(e=0;e<_.length;e++)n.write(_[e]);_=[],b=!0,a(y.Push,u+d+f,n.buffer,function(e){if(b=!1,!e||e.byteLength<=0)return void o("ajax socket: push: invalid server response");var t=new ByteBuffer(e,ByteBuffer.BIG_ENDIAN);f=t.readString(),_.length>0&&B()})}},50);return w.open=function(){a(y.Init,null,null,function(e){if(!e||e.byteLength<=0)return void o("ajax socket: open: invalid server response");var t=new ByteBuffer(e,ByteBuffer.BIG_ENDIAN);e=t.readString();var n=e.split(d);return 3!==n.length?void o("ajax socket: failed to obtain uid and tokens"):(u=n[0],s=n[1],f=n[2],c(),void w.onOpen())})},w.send=function(e){_.push(e),B()},w.close=function(){r()},w},c={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},h={forceSocketType:!1,connectTimeout:1e4},l=!1,d={socketType:function(){return u.socketType},close:function(){u.close(),i()},isClosed:function(){return l},write:function(e){return l?void console.log("BinarySocket: failed to write: the socket is closed"):e instanceof ArrayBuffer?void(0!==e.byteLength&&u.send(e)):void console.log("BinarySocket: failed to write data: data is not of type ArrayBuffer")},onRead:function(e){}};return window.ArrayBuffer?(n=e.extend({},h,n),t.match("^/")?t=window.location.protocol+"//"+window.location.host+t:t||(t=window.location.protocol+"//"+window.location.host),t.match("^http://")||t.match("^https://")?(a(),d):void console.log("BinarySocket: invalid host: missing 'http://' or 'https://'!")):void console.log("BinarySocket: ArrayBuffers are not supported by this browser!")};return{open:t,newByteBuffer:function(e,t){return new ByteBuffer(e,ByteBuffer.BIG_ENDIAN,t)},bytesToString:function(e){var t=this.newByteBuffer(e);return t.readString()},stringToBytes:function(e){var t=this.newByteBuffer(1,!0);return t.writeString(e),t.buffer}}}();